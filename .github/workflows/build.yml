name: 'Build'

on:
  workflow_dispatch:
    inputs:
      kernel_ver:
        description: 'WSL2 kernel version'
        required: true
        type: string
        default: '6.6.36.3'
      zfs_ver:
        description: 'ZFS version'
        required: true
        type: string
        default: '2.2.4'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 'Install build dependencies'
        run: >
          sudo apt-get update &&
          sudo apt-get -y install
          build-essential flex bison dwarves libssl-dev libelf-dev python3
          autoconf automake libtool gawk alien fakeroot dkms libblkid-dev uuid-dev libudev-dev libssl-dev zlib1g-dev libaio-dev libattr1-dev libelf-dev linux-headers-generic python3-dev python3-setuptools python3-cffi libffi-dev

      - name: 'Prepare WSL2 kernel source'
        run: |
          curl -L https://github.com/microsoft/WSL2-Linux-Kernel/archive/refs/tags/linux-msft-wsl-${{ inputs.kernel_ver }}.tar.gz -o wsl2.tar.gz
          tar xfz wsl2.tar.gz
          cd WSL2-Linux-Kernel-linux-msft-wsl-${{ inputs.kernel_ver }}
          make -j$(nproc) prepare KCONFIG_CONFIG=$(pwd)/Microsoft/config-wsl

      - name: 'Prepare ZFS source'
        run: |
          curl -L https://github.com/openzfs/zfs/archive/refs/tags/zfs-${{ inputs.zfs_ver }}.tar.gz -o zfs.tar.gz
          tar xfz zfs.tar.gz
          cd zfs-zfs-${{ inputs.zfs_ver }}
          sh autogen.sh
          ./configure --with-linux=$(pwd)/../WSL2-Linux-Kernel-linux-msft-wsl-${{ inputs.kernel_ver }} --with-linux-obj=$(pwd)/../WSL2-Linux-Kernel-linux-msft-wsl-${{ inputs.kernel_ver }} --enable-linux-builtin
          ./copy-builtin ../WSL2-Linux-Kernel-linux-msft-wsl-${{ inputs.kernel_ver }}

      - name: 'Apply module configuration from 5.15 (part 1)'
        run: |
          cd WSL2-Linux-Kernel-linux-msft-wsl-${{ inputs.kernel_ver }}
          sed -i Microsoft/config-wsl -e 's/CONFIG_ACPI_AC=m/CONFIG_ACPI_AC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_ACPI_BATTERY=m/CONFIG_ACPI_BATTERY=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_KVM=m/CONFIG_KVM=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_KVM_INTEL=m/CONFIG_KVM_INTEL=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_KVM_AMD=m/CONFIG_KVM_AMD=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_PACKET_DIAG=m/CONFIG_PACKET_DIAG=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_UNIX_DIAG=m/CONFIG_UNIX_DIAG=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_XFRM_ALGO=m/CONFIG_XFRM_ALGO=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_XFRM_USER=m/CONFIG_XFRM_USER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_XFRM_ESP=m/CONFIG_XFRM_ESP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_INET_ESP=m/CONFIG_INET_ESP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_BRIDGE_NETFILTER=m/CONFIG_BRIDGE_NETFILTER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_NETLINK_QUEUE=m/CONFIG_NETFILTER_NETLINK_QUEUE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_LOG_SYSLOG=m/CONFIG_NF_LOG_SYSLOG=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_CONNCOUNT=m/CONFIG_NETFILTER_CONNCOUNT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_CONNTRACK_AMANDA=m/CONFIG_NF_CONNTRACK_AMANDA=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_CONNTRACK_FTP=m/CONFIG_NF_CONNTRACK_FTP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_CONNTRACK_H323=m/CONFIG_NF_CONNTRACK_H323=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_CONNTRACK_IRC=m/CONFIG_NF_CONNTRACK_IRC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_CONNTRACK_BROADCAST=m/CONFIG_NF_CONNTRACK_BROADCAST=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_CONNTRACK_NETBIOS_NS=m/CONFIG_NF_CONNTRACK_NETBIOS_NS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_CONNTRACK_PPTP=m/CONFIG_NF_CONNTRACK_PPTP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_CONNTRACK_SANE=m/CONFIG_NF_CONNTRACK_SANE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_CONNTRACK_SIP=m/CONFIG_NF_CONNTRACK_SIP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_CONNTRACK_TFTP=m/CONFIG_NF_CONNTRACK_TFTP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_CT_NETLINK=m/CONFIG_NF_CT_NETLINK=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_NAT_AMANDA=m/CONFIG_NF_NAT_AMANDA=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_NAT_FTP=m/CONFIG_NF_NAT_FTP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_NAT_IRC=m/CONFIG_NF_NAT_IRC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_NAT_SIP=m/CONFIG_NF_NAT_SIP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_NAT_TFTP=m/CONFIG_NF_NAT_TFTP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_SYNPROXY=m/CONFIG_NETFILTER_SYNPROXY=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFT_NUMGEN=m/CONFIG_NFT_NUMGEN=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFT_CT=m/CONFIG_NFT_CT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFT_CONNLIMIT=m/CONFIG_NFT_CONNLIMIT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFT_LOG=m/CONFIG_NFT_LOG=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFT_LIMIT=m/CONFIG_NFT_LIMIT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFT_REDIR=m/CONFIG_NFT_REDIR=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFT_TUNNEL=m/CONFIG_NFT_TUNNEL=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFT_REJECT=m/CONFIG_NFT_REJECT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFT_REJECT_INET=m/CONFIG_NFT_REJECT_INET=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFT_COMPAT=m/CONFIG_NFT_COMPAT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_MARK=m/CONFIG_NETFILTER_XT_MARK=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_SET=m/CONFIG_NETFILTER_XT_SET=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_TARGET_CHECKSUM=m/CONFIG_NETFILTER_XT_TARGET_CHECKSUM=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_TARGET_HL=m/CONFIG_NETFILTER_XT_TARGET_HL=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_TARGET_LOG=m/CONFIG_NETFILTER_XT_TARGET_LOG=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_TARGET_MARK=m/CONFIG_NETFILTER_XT_TARGET_MARK=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_NAT=m/CONFIG_NETFILTER_XT_NAT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_TARGET_NETMAP=m/CONFIG_NETFILTER_XT_TARGET_NETMAP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_TARGET_NFLOG=m/CONFIG_NETFILTER_XT_TARGET_NFLOG=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_TARGET_REDIRECT=m/CONFIG_NETFILTER_XT_TARGET_REDIRECT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_TARGET_MASQUERADE=m/CONFIG_NETFILTER_XT_TARGET_MASQUERADE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_TARGET_SECMARK=m/CONFIG_NETFILTER_XT_TARGET_SECMARK=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=m/CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_MATCH_CGROUP=m/CONFIG_NETFILTER_XT_MATCH_CGROUP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_MATCH_COMMENT=m/CONFIG_NETFILTER_XT_MATCH_COMMENT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_MATCH_CONNTRACK=m/CONFIG_NETFILTER_XT_MATCH_CONNTRACK=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_MATCH_ECN=m/CONFIG_NETFILTER_XT_MATCH_ECN=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_MATCH_IPVS=m/CONFIG_NETFILTER_XT_MATCH_IPVS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_MATCH_LIMIT=m/CONFIG_NETFILTER_XT_MATCH_LIMIT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_MATCH_MULTIPORT=m/CONFIG_NETFILTER_XT_MATCH_MULTIPORT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_MATCH_OWNER=m/CONFIG_NETFILTER_XT_MATCH_OWNER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_MATCH_PHYSDEV=m/CONFIG_NETFILTER_XT_MATCH_PHYSDEV=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NETFILTER_XT_MATCH_STATISTIC=m/CONFIG_NETFILTER_XT_MATCH_STATISTIC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET=m/CONFIG_IP_SET=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_BITMAP_IP=m/CONFIG_IP_SET_BITMAP_IP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_BITMAP_IPMAC=m/CONFIG_IP_SET_BITMAP_IPMAC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_BITMAP_PORT=m/CONFIG_IP_SET_BITMAP_PORT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_HASH_IP=m/CONFIG_IP_SET_HASH_IP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_HASH_IPMARK=m/CONFIG_IP_SET_HASH_IPMARK=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_HASH_IPPORT=m/CONFIG_IP_SET_HASH_IPPORT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_HASH_IPPORTIP=m/CONFIG_IP_SET_HASH_IPPORTIP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_HASH_IPPORTNET=m/CONFIG_IP_SET_HASH_IPPORTNET=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_HASH_IPMAC=m/CONFIG_IP_SET_HASH_IPMAC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_HASH_MAC=m/CONFIG_IP_SET_HASH_MAC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_HASH_NETPORTNET=m/CONFIG_IP_SET_HASH_NETPORTNET=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_HASH_NET=m/CONFIG_IP_SET_HASH_NET=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_HASH_NETNET=m/CONFIG_IP_SET_HASH_NETNET=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_HASH_NETPORT=m/CONFIG_IP_SET_HASH_NETPORT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SET_HASH_NETIFACE=m/CONFIG_IP_SET_HASH_NETIFACE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_VS=m/CONFIG_IP_VS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_VS_RR=m/CONFIG_IP_VS_RR=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_VS_WRR=m/CONFIG_IP_VS_WRR=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_VS_SH=m/CONFIG_IP_VS_SH=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_SOCKET_IPV4=m/CONFIG_NF_SOCKET_IPV4=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFT_REJECT_IPV4=m/CONFIG_NFT_REJECT_IPV4=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_LOG_IPV4=m/CONFIG_NF_LOG_IPV4=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_REJECT_IPV4=m/CONFIG_NF_REJECT_IPV4=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_NAT_PPTP=m/CONFIG_NF_NAT_PPTP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_NAT_H323=m/CONFIG_NF_NAT_H323=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_IPTABLES=m/CONFIG_IP_NF_IPTABLES=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_MATCH_AH=m/CONFIG_IP_NF_MATCH_AH=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_MATCH_ECN=m/CONFIG_IP_NF_MATCH_ECN=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_MATCH_RPFILTER=m/CONFIG_IP_NF_MATCH_RPFILTER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_MATCH_TTL=m/CONFIG_IP_NF_MATCH_TTL=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_FILTER=m/CONFIG_IP_NF_FILTER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_TARGET_REJECT=m/CONFIG_IP_NF_TARGET_REJECT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_TARGET_SYNPROXY=m/CONFIG_IP_NF_TARGET_SYNPROXY=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_NAT=m/CONFIG_IP_NF_NAT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_TARGET_MASQUERADE=m/CONFIG_IP_NF_TARGET_MASQUERADE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_TARGET_NETMAP=m/CONFIG_IP_NF_TARGET_NETMAP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_TARGET_REDIRECT=m/CONFIG_IP_NF_TARGET_REDIRECT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_MANGLE=m/CONFIG_IP_NF_MANGLE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_TARGET_ECN=m/CONFIG_IP_NF_TARGET_ECN=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_TARGET_TTL=m/CONFIG_IP_NF_TARGET_TTL=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_RAW=m/CONFIG_IP_NF_RAW=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_SECURITY=m/CONFIG_IP_NF_SECURITY=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_ARPTABLES=m/CONFIG_IP_NF_ARPTABLES=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_ARPFILTER=m/CONFIG_IP_NF_ARPFILTER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_NF_ARP_MANGLE=m/CONFIG_IP_NF_ARP_MANGLE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_SOCKET_IPV6=m/CONFIG_NF_SOCKET_IPV6=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFT_REJECT_IPV6=m/CONFIG_NFT_REJECT_IPV6=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_REJECT_IPV6=m/CONFIG_NF_REJECT_IPV6=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NF_LOG_IPV6=m/CONFIG_NF_LOG_IPV6=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_IPTABLES=m/CONFIG_IP6_NF_IPTABLES=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_MATCH_AH=m/CONFIG_IP6_NF_MATCH_AH=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_MATCH_EUI64=m/CONFIG_IP6_NF_MATCH_EUI64=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_MATCH_FRAG=m/CONFIG_IP6_NF_MATCH_FRAG=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_MATCH_OPTS=m/CONFIG_IP6_NF_MATCH_OPTS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_MATCH_HL=m/CONFIG_IP6_NF_MATCH_HL=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_MATCH_IPV6HEADER=m/CONFIG_IP6_NF_MATCH_IPV6HEADER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_MATCH_MH=m/CONFIG_IP6_NF_MATCH_MH=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_MATCH_RPFILTER=m/CONFIG_IP6_NF_MATCH_RPFILTER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_MATCH_RT=m/CONFIG_IP6_NF_MATCH_RT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_TARGET_HL=m/CONFIG_IP6_NF_TARGET_HL=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_FILTER=m/CONFIG_IP6_NF_FILTER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_TARGET_REJECT=m/CONFIG_IP6_NF_TARGET_REJECT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_TARGET_SYNPROXY=m/CONFIG_IP6_NF_TARGET_SYNPROXY=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_MANGLE=m/CONFIG_IP6_NF_MANGLE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_RAW=m/CONFIG_IP6_NF_RAW=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_SECURITY=m/CONFIG_IP6_NF_SECURITY=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_NAT=m/CONFIG_IP6_NF_NAT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_TARGET_MASQUERADE=m/CONFIG_IP6_NF_TARGET_MASQUERADE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP6_NF_TARGET_NPT=m/CONFIG_IP6_NF_TARGET_NPT=y/'

      - name: 'Apply module configuration from 5.15 (part 2)'
        run: |
          cd WSL2-Linux-Kernel-linux-msft-wsl-${{ inputs.kernel_ver }}
          sed -i Microsoft/config-wsl -e 's/CONFIG_IP_SCTP=m/CONFIG_IP_SCTP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_INET_SCTP_DIAG=m/CONFIG_INET_SCTP_DIAG=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_STP=m/CONFIG_STP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_BRIDGE=m/CONFIG_BRIDGE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_VLAN_8021Q=m/CONFIG_VLAN_8021Q=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_LLC=m/CONFIG_LLC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NET_SCH_MULTIQ=m/CONFIG_NET_SCH_MULTIQ=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NET_SCH_FQ_CODEL=m/CONFIG_NET_SCH_FQ_CODEL=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NET_SCH_INGRESS=m/CONFIG_NET_SCH_INGRESS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NET_CLS_U32=m/CONFIG_NET_CLS_U32=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NET_CLS_CGROUP=m/CONFIG_NET_CLS_CGROUP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NET_CLS_BPF=m/CONFIG_NET_CLS_BPF=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NET_CLS_FLOWER=m/CONFIG_NET_CLS_FLOWER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NET_ACT_MIRRED=m/CONFIG_NET_ACT_MIRRED=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NET_ACT_IPT=m/CONFIG_NET_ACT_IPT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NET_ACT_BPF=m/CONFIG_NET_ACT_BPF=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_DNS_RESOLVER=m/CONFIG_DNS_RESOLVER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_VSOCKETS_DIAG=m/CONFIG_VSOCKETS_DIAG=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CEPH_LIB=m/CONFIG_CEPH_LIB=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_VIRTIO_BLK=m/CONFIG_VIRTIO_BLK=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_BLK_DEV_MD=m/CONFIG_BLK_DEV_MD=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_MD_RAID0=m/CONFIG_MD_RAID0=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_MD_RAID1=m/CONFIG_MD_RAID1=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_MD_RAID10=m/CONFIG_MD_RAID10=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_MD_RAID456=m/CONFIG_MD_RAID456=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_DM_BIO_PRISON=m/CONFIG_DM_BIO_PRISON=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_DM_PERSISTENT_DATA=m/CONFIG_DM_PERSISTENT_DATA=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_DM_CRYPT=m/CONFIG_DM_CRYPT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_DM_THIN_PROVISIONING=m/CONFIG_DM_THIN_PROVISIONING=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_DM_RAID=m/CONFIG_DM_RAID=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_MII=m/CONFIG_MII=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_WIREGUARD=m/CONFIG_WIREGUARD=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_MACVLAN=m/CONFIG_MACVLAN=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_MACVTAP=m/CONFIG_MACVTAP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IPVLAN=m/CONFIG_IPVLAN=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_GENEVE=m/CONFIG_GENEVE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_TUN=m/CONFIG_TUN=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_TAP=m/CONFIG_TAP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_PPP_BSDCOMP=m/CONFIG_PPP_BSDCOMP=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_PPP_DEFLATE=m/CONFIG_PPP_DEFLATE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_PPP_MPPE=m/CONFIG_PPP_MPPE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_PPPOE=m/CONFIG_PPPOE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_PPP_ASYNC=m/CONFIG_PPP_ASYNC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_PPP_SYNC_TTY=m/CONFIG_PPP_SYNC_TTY=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_USB_NET_DRIVERS=m/CONFIG_USB_NET_DRIVERS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_USB_USBNET=m/CONFIG_USB_USBNET=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_USB_NET_CDCETHER=m/CONFIG_USB_NET_CDCETHER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_USB_NET_CDC_NCM=m/CONFIG_USB_NET_CDC_NCM=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_USB_RTL8153_ECM=m/CONFIG_USB_RTL8153_ECM=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NVRAM=m/CONFIG_NVRAM=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_I2C_ALGOBIT=m/CONFIG_I2C_ALGOBIT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_DRM_VGEM=m/CONFIG_DRM_VGEM=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_HID=m/CONFIG_HID=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_HID_GENERIC=m/CONFIG_HID_GENERIC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_USB_HID=m/CONFIG_USB_HID=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_USB_COMMON=m/CONFIG_USB_COMMON=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_USB=m/CONFIG_USB=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_USB_ACM=m/CONFIG_USB_ACM=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_USBIP_CORE=m/CONFIG_USBIP_CORE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_USBIP_VHCI_HCD=m/CONFIG_USBIP_VHCI_HCD=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_UIO=m/CONFIG_UIO=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_VFIO=m/CONFIG_VFIO=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_VFIO_IOMMU_TYPE1=m/CONFIG_VFIO_IOMMU_TYPE1=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_VFIO_PCI_CORE=m/CONFIG_VFIO_PCI_CORE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_VFIO_PCI=m/CONFIG_VFIO_PCI=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_IRQ_BYPASS_MANAGER=m/CONFIG_IRQ_BYPASS_MANAGER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_VIRTIO_MEM=m/CONFIG_VIRTIO_MEM=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_VHOST_IOTLB=m/CONFIG_VHOST_IOTLB=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_VHOST=m/CONFIG_VHOST=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_VHOST_NET=m/CONFIG_VHOST_NET=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_DEV_DAX=m/CONFIG_DEV_DAX=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_DEV_DAX_PMEM=m/CONFIG_DEV_DAX_PMEM=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_DEV_DAX_KMEM=m/CONFIG_DEV_DAX_KMEM=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_BTRFS_FS=m/CONFIG_BTRFS_FS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_AUTOFS_FS=m/CONFIG_AUTOFS_FS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CUSE=m/CONFIG_CUSE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_ISO9660_FS=m/CONFIG_ISO9660_FS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_MSDOS_FS=m/CONFIG_MSDOS_FS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_EROFS_FS=m/CONFIG_EROFS_FS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFS_FS=m/CONFIG_NFS_FS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFS_V2=m/CONFIG_NFS_V2=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFS_V3=m/CONFIG_NFS_V3=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFS_V4=m/CONFIG_NFS_V4=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_PNFS_FILE_LAYOUT=m/CONFIG_PNFS_FILE_LAYOUT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_PNFS_BLOCK=m/CONFIG_PNFS_BLOCK=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_PNFS_FLEXFILE_LAYOUT=m/CONFIG_PNFS_FLEXFILE_LAYOUT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFSD=m/CONFIG_NFSD=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_GRACE_PERIOD=m/CONFIG_GRACE_PERIOD=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_LOCKD=m/CONFIG_LOCKD=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_NFS_ACL_SUPPORT=m/CONFIG_NFS_ACL_SUPPORT=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_SUNRPC=m/CONFIG_SUNRPC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_SUNRPC_GSS=m/CONFIG_SUNRPC_GSS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CEPH_FS=m/CONFIG_CEPH_FS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CIFS=m/CONFIG_CIFS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_XOR_BLOCKS=m/CONFIG_XOR_BLOCKS=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_ASYNC_CORE=m/CONFIG_ASYNC_CORE=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_ASYNC_MEMCPY=m/CONFIG_ASYNC_MEMCPY=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_ASYNC_XOR=m/CONFIG_ASYNC_XOR=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_ASYNC_PQ=m/CONFIG_ASYNC_PQ=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_ASYNC_RAID6_RECOV=m/CONFIG_ASYNC_RAID6_RECOV=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_AUTHENC=m/CONFIG_CRYPTO_AUTHENC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_DES=m/CONFIG_CRYPTO_DES=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_ARC4=m/CONFIG_CRYPTO_ARC4=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_CCM=m/CONFIG_CRYPTO_CCM=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_ECHAINIV=m/CONFIG_CRYPTO_ECHAINIV=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_ESSIV=m/CONFIG_CRYPTO_ESSIV=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_BLAKE2B=m/CONFIG_CRYPTO_BLAKE2B=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_CMAC=m/CONFIG_CRYPTO_CMAC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_MD4=m/CONFIG_CRYPTO_MD4=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_XXHASH=m/CONFIG_CRYPTO_XXHASH=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_USER_API=m/CONFIG_CRYPTO_USER_API=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_USER_API_HASH=m/CONFIG_CRYPTO_USER_API_HASH=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_USER_API_SKCIPHER=m/CONFIG_CRYPTO_USER_API_SKCIPHER=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_CURVE25519_X86=m/CONFIG_CRYPTO_CURVE25519_X86=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_CHACHA20_X86_64=m/CONFIG_CRYPTO_CHACHA20_X86_64=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_POLY1305_X86_64=m/CONFIG_CRYPTO_POLY1305_X86_64=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_RAID6_PQ=m/CONFIG_RAID6_PQ=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_LIB_ARC4=m/CONFIG_CRYPTO_LIB_ARC4=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_ARCH_HAVE_LIB_CHACHA=m/CONFIG_CRYPTO_ARCH_HAVE_LIB_CHACHA=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_LIB_CHACHA_GENERIC=m/CONFIG_CRYPTO_LIB_CHACHA_GENERIC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_LIB_CHACHA=m/CONFIG_CRYPTO_LIB_CHACHA=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_ARCH_HAVE_LIB_CURVE25519=m/CONFIG_CRYPTO_ARCH_HAVE_LIB_CURVE25519=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_LIB_CURVE25519_GENERIC=m/CONFIG_CRYPTO_LIB_CURVE25519_GENERIC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_LIB_CURVE25519=m/CONFIG_CRYPTO_LIB_CURVE25519=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_LIB_DES=m/CONFIG_CRYPTO_LIB_DES=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_ARCH_HAVE_LIB_POLY1305=m/CONFIG_CRYPTO_ARCH_HAVE_LIB_POLY1305=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_LIB_POLY1305_GENERIC=m/CONFIG_CRYPTO_LIB_POLY1305_GENERIC=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_LIB_POLY1305=m/CONFIG_CRYPTO_LIB_POLY1305=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_CRYPTO_LIB_CHACHA20POLY1305=m/CONFIG_CRYPTO_LIB_CHACHA20POLY1305=y/'
          sed -i Microsoft/config-wsl -e 's/CONFIG_TEXTSEARCH_KMP=m/CONFIG_TEXTSEARCH_KMP=y/'

      - name: 'Build kernel'
        run: |
          cd WSL2-Linux-Kernel-linux-msft-wsl-${{ inputs.kernel_ver }}
          sed -i Microsoft/config-wsl -e 's/standard-WSL2/standard-WSL2-zfs-${{ inputs.zfs_ver }}/'
          echo "CONFIG_ZFS=y" >> Microsoft/config-wsl
          make -j$(nproc) KCONFIG_CONFIG=Microsoft/config-wsl

      - name: 'Publish built kernel'
        uses: actions/upload-artifact@v4
        with:
          name: wsl2-kernel-${{ inputs.kernel_ver }}-zfs-${{ inputs.zfs_ver }}
          path: WSL2-Linux-Kernel-linux-msft-wsl-${{ inputs.kernel_ver }}/arch/x86/boot/bzImage
          overwrite: true
